<!DOCTYPE html>
<html lang="ru">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Видео — только TheHati</title>
    <style>
        /* cyrillic-ext */
        @font-face {
            font-family: 'Montserrat';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/montserrat/v31/JTUSjIg1_i6t8kCHKm459WRhyzbi.woff2) format('woff2');
            unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
        }

        /* cyrillic */
        @font-face {
            font-family: 'Montserrat';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/montserrat/v31/JTUSjIg1_i6t8kCHKm459W1hyzbi.woff2) format('woff2');
            unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
        }

        /* vietnamese */
        @font-face {
            font-family: 'Montserrat';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/montserrat/v31/JTUSjIg1_i6t8kCHKm459WZhyzbi.woff2) format('woff2');
            unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
        }

        /* latin-ext */
        @font-face {
            font-family: 'Montserrat';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/montserrat/v31/JTUSjIg1_i6t8kCHKm459Wdhyzbi.woff2) format('woff2');
            unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
        }

        /* latin */
        @font-face {
            font-family: 'Montserrat';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/montserrat/v31/JTUSjIg1_i6t8kCHKm459Wlhyw.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }

        /* cyrillic-ext */
        @font-face {
            font-family: 'Montserrat';
            font-style: normal;
            font-weight: 700;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/montserrat/v31/JTUSjIg1_i6t8kCHKm459WRhyzbi.woff2) format('woff2');
            unicode-range: U+0460-052F, U+1C80-1C8A, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
        }

        /* cyrillic */
        @font-face {
            font-family: 'Montserrat';
            font-style: normal;
            font-weight: 700;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/montserrat/v31/JTUSjIg1_i6t8kCHKm459W1hyzbi.woff2) format('woff2');
            unicode-range: U+0301, U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
        }

        /* vietnamese */
        @font-face {
            font-family: 'Montserrat';
            font-style: normal;
            font-weight: 700;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/montserrat/v31/JTUSjIg1_i6t8kCHKm459WZhyzbi.woff2) format('woff2');
            unicode-range: U+0102-0103, U+0110-0111, U+0128-0129, U+0168-0169, U+01A0-01A1, U+01AF-01B0, U+0300-0301, U+0303-0304, U+0308-0309, U+0323, U+0329, U+1EA0-1EF9, U+20AB;
        }

        /* latin-ext */
        @font-face {
            font-family: 'Montserrat';
            font-style: normal;
            font-weight: 700;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/montserrat/v31/JTUSjIg1_i6t8kCHKm459Wdhyzbi.woff2) format('woff2');
            unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
        }

        /* latin */
        @font-face {
            font-family: 'Montserrat';
            font-style: normal;
            font-weight: 700;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/montserrat/v31/JTUSjIg1_i6t8kCHKm459Wlhyw.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }


        body {
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            background-color: #000;
            color: #fff;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 20px;
        }

        .total-views {
            width: 100%;
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .update-info {
            width: 100%;
            text-align: center;
            font-size: 0.9em;
            color: #858585;
            margin-bottom: 20px;
        }

        .tile {
            background-color: #1a1a1a;
            border-radius: 10px;
            margin: 10px;
            max-width: 300px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .tile:hover img {
            transform: scale(1.05);
        }

        .tile img {
            width: 100%;
            border-radius: 10px;
            transition: transform 0.3s;
            position: relative;
            z-index: 1;
        }

        .title {
            font-size: 1.2em;
            margin: 10px 0;
            position: relative;
            z-index: 1;
        }

        .info {
            font-size: 0.9em;
            color: #858585;
            margin: 5px 0;
            position: relative;
            z-index: 1;
        }

        .nickname {
            color: #ccc;
        }

        .info .nickname {
            font-weight: bold;
            font-size: 1.2em;
        }

        .background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('/logo.png') repeat;
            background-size: 50px 50px;
            animation: scroll 10s linear infinite;
            z-index: -1;
            opacity: 0.1;
        }

        @keyframes scroll {
            from {
                background-position: 0 0;
            }

            to {
                background-position: -100px -100px;
            }
        }

        ::-webkit-scrollbar {
            width: 9px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a00;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #ffffff, #ffffff);
            border-radius: 10px;
            border: 2px solid #000;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, #ffffff, #ffffff)
        }

        body {
            scrollbar-width: thin;
            scrollbar-color: #ffffff #1a1a1a;
        }

        ::selection {
            background: #fff;
            color: #000;
        }

        .home-icon {
            position: absolute;
            top: 20px;
            left: 20px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            transition: transform 0.3s;
        }

        .home-icon:hover {
            transform: scale(1.1);
        }

        .home-icon img {
            width: 100%;
            height: 100%;
        }

        .total-views {
            width: 100%;
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 5px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .icon-with-number {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .icon-with-number img.icon {
            width: 24px;
            height: 24px;
        }

        .filter-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            transition: transform 0.3s;
        }

        .filter-icon:hover {
            transform: rotate(90deg);
        }

        .filter-icon img {
            width: 100%;
            height: 100%;
        }

        .filters-popup {
            position: fixed;
            top: 20px;
            right: -350px;
            width: 300px;
            background-color: #1a1a1a;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
            padding: 20px;
        }

        .filters-popup.open {
            transform: translateX(-370px);
        }

        .filters-content select {
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
            font-size: 1em;
            border-radius: 5px;
            border: none;
            background-color: #333;
            color: #fff;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
        }

        .tile .background-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0.1;
            z-index: 0;
        }

        .only-channel-note {
            position: fixed;
            left: 80px;
            top: 16px;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            z-index: 9999;
        }

        .download-json-btn {
            position: absolute;
            top: 70px;
            right: 20px;
            background-color: #333;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            transition: background-color 0.3s;
        }

        .download-json-btn:hover {
            background-color: #555;
        }
    </style>
</head>

<body>

    <div class="total-views">
        <span class="icon-with-number">
            <img src="view.png" alt="Просмотры" class="icon" draggable="false"> <span
                id="totalViewsCount">0</span>
        </span>
        <span class="icon-with-number">
            <img src="video_list.png" alt="Видео" class="icon" draggable="false"> <span
                id="totalVideosCount">0</span>
        </span>
    </div>

    <div class="update-info" id="updateInfo">*статистика обновляется раз в час</div>

    <div class="filters-popup">
        <div class="filters-content">
            <select id="sort-by">
                <option value="date-desc" selected>По дате (сначала новые)</option>
                <option value="date-asc">По дате (сначала старые)</option>
                <option value="views-desc">По количеству просмотров (по убыванию)</option>
                <option value="views-asc">По количеству просмотров (по возрастанию)</option>
            </select>
            <select id="filter-by-channel">
                <option value="TheHati" selected>TheHati</option>
            </select>
        </div>
    </div>

    <div class="background"></div>

    <script>
        const API_KEY = process.env.API_KEY;
        const CHANNEL_USERNAME = 'TheHati';
        const CACHE_KEY = 'youtube_videos_cache';
        const CACHE_TIMESTAMP_KEY = 'youtube_videos_cache_timestamp';
        const CACHE_DURATION = 60 * 60 * 1000; // 1 hour in milliseconds

        // Название канала для фильтрации
        const ONLY_CHANNEL = 'thehati';

        let videosFromDB = [];

        // Функция для проверки, нужно ли обновлять кеш
        function shouldUpdateCache() {
            const cachedTimestamp = JSON.parse(window.localStorage.getItem(CACHE_TIMESTAMP_KEY));
            if (!cachedTimestamp) return true;
            
            const now = Date.now();
            return (now - cachedTimestamp) > CACHE_DURATION;
        }

        // Функция для получения данных из кеша
        function getFromCache() {
            try {
                const cachedData = window.localStorage.getItem(CACHE_KEY);
                if (cachedData) {
                    return JSON.parse(cachedData);
                }
            } catch (error) {
                console.error('Error reading from cache:', error);
            }
            return null;
        }

        // Функция для сохранения данных в кеш
        function saveToCache(data) {
            try {
                window.localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                window.localStorage.setItem(CACHE_TIMESTAMP_KEY, JSON.stringify(Date.now()));
                updateCacheInfo();
            } catch (error) {
                console.error('Error saving to cache:', error);
            }
        }

        // Обновление информации о времени последнего обновления
        function updateCacheInfo() {
            const timestamp = JSON.parse(window.localStorage.getItem(CACHE_TIMESTAMP_KEY));
            if (timestamp) {
                const date = new Date(timestamp);
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                document.getElementById('updateInfo').textContent = 
                    `*последнее обновление: ${hours}:${minutes}`;
            }
        }

        // Функция для скачивания JSON файла
        function downloadJSON() {
            const dataStr = JSON.stringify(videosFromDB, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `thehati_videos_${Date.now()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        async function getChannelId(username) {
            const url = `https://youtube.googleapis.com/youtube/v3/channels?part=id&forUsername=${username}&key=${API_KEY}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    return data.items[0].id;
                }

                const searchUrl = `https://youtube.googleapis.com/youtube/v3/search?part=snippet&type=channel&q=${username}&key=${API_KEY}`;
                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();

                if (searchData.items && searchData.items.length > 0) {
                    return searchData.items[0].id.channelId;
                }

                throw new Error('Channel not found');
            } catch (error) {
                console.error('Error fetching channel ID:', error);
                throw error;
            }
        }

        async function getChannelVideos(channelId, maxResults = 50) {
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&order=date&type=video&maxResults=${maxResults}&key=${API_KEY}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (!data.items) {
                    throw new Error('No videos found');
                }

                const videoIds = data.items.map(item => item.id.videoId).join(',');

                const statsUrl = `https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${videoIds}&key=${API_KEY}`;
                const statsResponse = await fetch(statsUrl);
                const statsData = await statsResponse.json();

                const statsMap = {};
                statsData.items.forEach(item => {
                    statsMap[item.id] = item.statistics;
                });

                const videosFromDB = data.items.map((item, index) => {
                    const videoId = item.id.videoId;
                    const stats = statsMap[videoId] || {};
                    const publishedDate = new Date(item.snippet.publishedAt);

                    const months = [
                        'января', 'февраля', 'марта', 'апреля', 'мая', 'июня',
                        'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'
                    ];
                    const formattedDate = `${publishedDate.getDate()} ${months[publishedDate.getMonth()]} ${publishedDate.getFullYear()}`;

                    return {
                        id: index + 1,
                        link: `https://youtu.be/${videoId}`,
                        name: item.snippet.title,
                        channel: CHANNEL_USERNAME.toLowerCase(),
                        view: parseInt(stats.viewCount) || 0,
                        date: formattedDate,
                        previe: item.snippet.thumbnails.maxres?.url ||
                            item.snippet.thumbnails.high.url
                    };
                });

                return videosFromDB;
            } catch (error) {
                console.error('Error fetching videos:', error);
                throw error;
            }
        }

        async function fetchChannelData() {
            try {
                console.log(`Fetching data for channel: ${CHANNEL_USERNAME}`);

                const channelId = await getChannelId(CHANNEL_USERNAME);
                console.log(`Channel ID: ${channelId}`);

                const videos = await getChannelVideos(channelId);

                console.log(`Found ${videos.length} videos`);

                videosFromDB = videos;
                saveToCache(videos);

                return videos;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        const filterOnlyChannel = (arr) => {
            return arr.filter(v => {
                const ch = (v.channel || '').toString().toLowerCase();
                return ch.includes(ONLY_CHANNEL) || ch === ONLY_CHANNEL || ch.includes('the hati');
            });
        };

        const parseDate = (str) => {
            try {
                const months = {
                    'января': '01', 'февраля': '02', 'марта': '03', 'апреля': '04', 'мая': '05', 'июня': '06',
                    'июля': '07', 'августа': '08', 'сентября': '09', 'октября': '10', 'ноября': '11', 'декабря': '12'
                };
                const parts = str.trim().split(' ');
                if (parts.length >= 3) {
                    const day = parts[0].padStart(2, '0');
                    const month = months[parts[1].toLowerCase()] || '01';
                    const year = parts[2];
                    return `${year}-${month}-${day}`;
                }
            } catch (e) { }
            return str;
        };

        const displayVideos = (videos) => {
            document.querySelectorAll('.tile').forEach(el => el.remove());

            videos.forEach(video => {
                const container = document.createElement('div');
                container.className = 'tile';
                container.onclick = () => window.open(video.link, '_blank');

                const bgImage = document.createElement('div');
                bgImage.className = 'background-image';
                bgImage.style.backgroundImage = `url("${video.previe || ''}")`;

                const thumbnailImg = document.createElement('img');
                thumbnailImg.src = video.previe || '';
                thumbnailImg.alt = video.name || '';

                const titleDiv = document.createElement('div');
                titleDiv.className = 'title';
                titleDiv.textContent = video.name || '';

                const infoDiv = document.createElement('div');
                infoDiv.className = 'info';
                const nick = document.createElement('span');
                nick.className = 'nickname';
                nick.textContent = video.channel || '';
                infoDiv.appendChild(nick);
                infoDiv.innerHTML += '<br>' + (video.view ? video.view.toLocaleString() + ' просмотров' : '') + '<br>' + (video.date || '');

                container.appendChild(bgImage);
                container.appendChild(thumbnailImg);
                container.appendChild(titleDiv);
                container.appendChild(infoDiv);

                document.body.appendChild(container);
            });
        };

        const updateTotalViews = (videos) => {
            const totalViews = videos.reduce((sum, video) => sum + (video.view || 0), 0);
            const totalVideos = videos.length;

            document.getElementById('totalViewsCount').textContent = totalViews.toLocaleString();
            document.getElementById('totalVideosCount').textContent = totalVideos;
        };

        document.addEventListener('DOMContentLoaded', async () => {
            // Проверяем, нужно ли обновлять данные
            if (shouldUpdateCache()) {
                console.log('Cache expired, fetching new data...');
                await fetchChannelData();
            } else {
                console.log('Using cached data...');
                const cachedVideos = getFromCache();
                if (cachedVideos) {
                    videosFromDB = cachedVideos;
                } else {
                    // Если кеш пуст, загружаем данные
                    await fetchChannelData();
                }
            }

            updateCacheInfo();

            if (!videosFromDB || videosFromDB.length === 0) {
                console.warn("Видео не загружены");
                displayVideos([]);
                return;
            }

            const prepared = videosFromDB.map(v => ({
                ...v,
                dateParsed: parseDate(v.date || "")
            }));

            let videos = filterOnlyChannel(prepared);
            videos.sort((a, b) => (b.dateParsed || "").localeCompare(a.dateParsed || ""));

            displayVideos(videos);
            updateTotalViews(videos);

            document.getElementById('sort-by').addEventListener('change', () => {
                const sortBy = document.getElementById('sort-by').value;
                if (sortBy === 'views-desc') videos.sort((a, b) => b.view - a.view);
                else if (sortBy === 'views-asc') videos.sort((a, b) => a.view - b.view);
                else if (sortBy === 'date-asc') videos.sort((a, b) => a.dateParsed.localeCompare(b.dateParsed));
                else videos.sort((a, b) => b.dateParsed.localeCompare(a.dateParsed));

                displayVideos(videos);
                updateTotalViews(videos);
            });
        });
    </script>
</body>

</html>